{% extends "base.html" %}
{% block title %}Controle de Produtos{% endblock %}

{% block content %}

<style>
  .card-compact .card-body {
    padding: 0.75rem;
  }
  
  .card-compact .form-label {
    margin-bottom: 0.25rem;
    font-size: 0.9rem;
  }
  
  .card-compact .form-control,
  .card-compact .form-select {
    padding: 0.4rem 0.6rem;
    font-size: 0.9rem;
  }
  
  .card-compact .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.9rem;
  }
  
  .card-compact .mb-3 {
    margin-bottom: 0.5rem !important;
  }
  
  .card-compact .mb-2 {
    margin-bottom: 0.35rem !important;
  }
  
  .table-scroll {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }
  
  .table-scroll table {
    margin-bottom: 0;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Controle de Produtos</h1>
    <div>
      <input id="searchInput" class="form-control" placeholder="Buscar produto por nome" style="width: 300px; display:inline-block;">
      <button id="btnSearch" class="btn btn-secondary ms-2">Buscar</button>
    </div>
  </div>

  <!-- Mensagens de status -->
  <div id="alerts"></div>

  <div class="row">
    <div class="col-md-4">
      <div class="card card-compact mb-3">
        <div class="card-header">Cadastrar Produto</div>
        <div class="card-body">
          <form id="formAddProduto">
            <div class="mb-3">
              <label class="form-label">Nome</label>
              <input type="text" id="produtoNome" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descrição</label>
              <textarea id="produtoDescricao" class="form-control" rows="2" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
          </form>
        </div>
      </div>

      <div class="card card-compact">
        <div class="card-header">Entrada / Saída</div>
        <div class="card-body">
          <form id="formMovimentacao">
            <div class="mb-2">
              <label class="form-label">Produto</label>
              <select id="selectProduto" class="form-select" required></select>
            </div>
            <div class="mb-2">
              <label class="form-label">Tipo</label>
              <select id="movTipo" class="form-select" required>
                <option value="entrada">Entrada</option>
                <option value="saida">Saída</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Quantidade</label>
              <input type="number" id="movQuantidade" class="form-control" min="1" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Descrição</label>
              <textarea id="movDescricao" class="form-control" rows="2" required></textarea>
            </div>
            <button type="submit" class="btn btn-success">Registrar</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card">
        <div class="card-header">Estoque Atual</div>
        <div class="table-scroll">
          <table class="table table-striped" id="tabelaProdutos">
            <thead class="table-dark">
              <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Última movimentação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal histórico (simples) -->
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Histórico — <span id="histProdutoNome" class="text-primary fw-bold"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-striped">
          <thead class="table-dark">
            <tr>
              <th>Data/Hora</th>
              <th>Tipo</th>
              <th>Quantidade</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Helpers
  function showAlert(tipo, texto, timeout = 4000) {
    const alerts = document.getElementById('alerts');
    const div = document.createElement('div');
    div.className = `alert alert-${tipo} mt-2`;
    div.textContent = texto;
    alerts.appendChild(div);
    setTimeout(()=> div.remove(), timeout);
  }

  // Carrega lista de produtos e popula tabela e select
  async function carregarProdutos(q="") {
    const res = await fetch(`/api/produtos?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    const tbody = document.querySelector('#tabelaProdutos tbody');
    const select = document.getElementById('selectProduto');
    tbody.innerHTML = '';
    select.innerHTML = '<option value="">Selecione...</option>';
    data.produtos.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.quantidade}</td>
        <td>${p.ultima_movimentacao_data ? p.ultima_movimentacao_data + " — " + (p.ultima_movimentacao_descricao || "") : "-"}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="excluirProduto(${p.id}, '${p.nome.replace(/'/g,'\\\'')}')">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);

      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.nome;
      select.appendChild(opt);
    });
  }

  // Cadastro produto
  document.getElementById('formAddProduto').addEventListener('submit', async (e) => {
    e.preventDefault();
    const nome = document.getElementById('produtoNome').value.trim();
    const descricao = document.getElementById('produtoDescricao').value.trim();
    const resp = await fetch('/api/produtos/add', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({nome, descricao})
    });
    const dados = await resp.json();
    if (resp.ok) {
      showAlert('success', 'Produto cadastrado com sucesso');
      document.getElementById('formAddProduto').reset();
      carregarProdutos();
    } else {
      showAlert('danger', dados.detalhe || 'Erro ao cadastrar');
    }
  });

  // Movimentação
  document.getElementById('formMovimentacao').addEventListener('submit', async (e) => {
    e.preventDefault();
    const produto_id = document.getElementById('selectProduto').value;
    const tipo = document.getElementById('movTipo').value;
    const quantidade = document.getElementById('movQuantidade').value;
    const descricao = document.getElementById('movDescricao').value.trim();
    if (!produto_id) return showAlert('warning', 'Selecione um produto');
    const resp = await fetch(`/api/produtos/${produto_id}/movimentar`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({tipo, quantidade, descricao})
    });
    const dados = await resp.json();
    if (resp.ok) {
      showAlert('success', 'Movimentação registrada');
      document.getElementById('formMovimentacao').reset();
      carregarProdutos();
    } else {
      showAlert('danger', dados.detalhe || 'Erro ao registrar movimentação');
    }
  });

  // Histórico
  async function verHistorico(produto_id, produto_nome) {
    try {
      console.log('Buscando histórico para produto_id:', produto_id);
      
      const res = await fetch(`/api/produtos/${produto_id}/historico`);
      console.log('Status da resposta:', res.status, res.statusText);
      
      if (!res.ok) {
        console.error('Erro HTTP:', res.status, res.statusText);
        showAlert('danger', `Erro ao carregar histórico (HTTP ${res.status})`);
        return;
      }
      
      const data = await res.json();
      console.log('Dados de histórico recebidos:', data);
      
      document.getElementById('histProdutoNome').textContent = produto_nome;
      const histBody = document.getElementById('histBody');
      histBody.innerHTML = '';
      
      if (!data.movimentacoes || data.movimentacoes.length === 0) {
        histBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma movimentação registrada</td></tr>';
      } else {
        data.movimentacoes.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.data_registro}</td>
            <td><span class="badge ${m.tipo === 'entrada' ? 'bg-success' : 'bg-danger'}">${m.tipo.toUpperCase()}</span></td>
            <td>${m.quantidade}</td>
            <td>${m.descricao}</td>
          `;
          histBody.appendChild(tr);
        });
      }
      
      // abrir modal (Bootstrap 5)
      const modal = new bootstrap.Modal(document.getElementById('modalHistorico'));
      modal.show();
    } catch (err) {
      console.error('Erro ao carregar histórico:', err);
      showAlert('danger', 'Erro ao carregar histórico: ' + err.message);
    }
  }

  // Excluir produto
  async function excluirProduto(produto_id, produto_nome) {
    if (!confirm(`Tem certeza que deseja excluir o produto "${produto_nome}"? Esta ação não pode ser desfeita.`)) {
      return;
    }
    const resp = await fetch(`/api/produtos/${produto_id}`, {
      method: 'DELETE',
      headers: {'Content-Type':'application/json'}
    });
    const dados = await resp.json();
    if (resp.ok) {
      showAlert('success', dados.mensagem || 'Produto excluído com sucesso');
      carregarProdutos();
    } else {
      showAlert('danger', dados.detalhe || 'Erro ao excluir produto');
    }
  }

  // Busca por nome
  document.getElementById('btnSearch').addEventListener('click', () => {
    carregarProdutos(document.getElementById('searchInput').value);
  });
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      carregarProdutos(document.getElementById('searchInput').value);
    }
  });

  // Carrega ao abrir
  carregarProdutos();
</script>

<!-- Modal histórico (simples) -->
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Histórico — <span id="histProdutoNome" class="text-primary fw-bold"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-sm table-striped">
          <thead class="table-dark">
            <tr>
              <th>Data/Hora</th>
              <th>Tipo</th>
              <th>Quantidade</th>
              <th>Descrição</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Helpers
  function showAlert(tipo, texto, timeout = 4000) {
    const alerts = document.getElementById('alerts');
    const div = document.createElement('div');
    div.className = `alert alert-${tipo} mt-2`;
    div.textContent = texto;
    alerts.appendChild(div);
    setTimeout(()=> div.remove(), timeout);
  }

  // Carrega lista de produtos e popula tabela e select
  async function carregarProdutos(q="") {
    const res = await fetch(`/api/produtos?q=${encodeURIComponent(q)}`);
    const data = await res.json();
    const tbody = document.querySelector('#tabelaProdutos tbody');
    const select = document.getElementById('selectProduto');
    tbody.innerHTML = '';
    select.innerHTML = '<option value="">Selecione...</option>';
    data.produtos.forEach(p => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p.nome}</td>
        <td>${p.quantidade}</td>
        <td>${p.ultima_movimentacao_data ? p.ultima_movimentacao_data + " — " + (p.ultima_movimentacao_descricao || "") : "-"}</td>
        <td>
          <button class="btn btn-sm btn-outline-danger" onclick="excluirProduto(${p.id}, '${p.nome.replace(/'/g,'\\\'')}')">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);

      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = p.nome;
      select.appendChild(opt);
    });
  }

  // Cadastro produto
  document.getElementById('formAddProduto').addEventListener('submit', async (e) => {
    e.preventDefault();
    const nome = document.getElementById('produtoNome').value.trim();
    const descricao = document.getElementById('produtoDescricao').value.trim();
    const resp = await fetch('/api/produtos/add', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({nome, descricao})
    });
    const dados = await resp.json();
    if (resp.ok) {
      showAlert('success', 'Produto cadastrado com sucesso');
      document.getElementById('formAddProduto').reset();
      carregarProdutos();
    } else {
      showAlert('danger', dados.detalhe || 'Erro ao cadastrar');
    }
  });

  // Movimentação
  document.getElementById('formMovimentacao').addEventListener('submit', async (e) => {
    e.preventDefault();
    const produto_id = document.getElementById('selectProduto').value;
    const tipo = document.getElementById('movTipo').value;
    const quantidade = document.getElementById('movQuantidade').value;
    const descricao = document.getElementById('movDescricao').value.trim();
    if (!produto_id) return showAlert('warning', 'Selecione um produto');
    const resp = await fetch(`/api/produtos/${produto_id}/movimentar`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({tipo, quantidade, descricao})
    });
    const dados = await resp.json();
    if (resp.ok) {
      showAlert('success', 'Movimentação registrada');
      document.getElementById('formMovimentacao').reset();
      carregarProdutos();
    } else {
      showAlert('danger', dados.detalhe || 'Erro ao registrar movimentação');
    }
  });

  // Histórico
  async function verHistorico(produto_id, produto_nome) {
    try {
      console.log('Buscando histórico para produto_id:', produto_id);
      
      const res = await fetch(`/api/produtos/${produto_id}/historico`);
      console.log('Status da resposta:', res.status, res.statusText);
      
      if (!res.ok) {
        console.error('Erro HTTP:', res.status, res.statusText);
        showAlert('danger', `Erro ao carregar histórico (HTTP ${res.status})`);
        return;
      }
      
      const data = await res.json();
      console.log('Dados de histórico recebidos:', data);
      
      document.getElementById('histProdutoNome').textContent = produto_nome;
      const histBody = document.getElementById('histBody');
      histBody.innerHTML = '';
      
      if (!data.movimentacoes || data.movimentacoes.length === 0) {
        histBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhuma movimentação registrada</td></tr>';
      } else {
        data.movimentacoes.forEach(m => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${m.data_registro}</td>
            <td><span class="badge ${m.tipo === 'entrada' ? 'bg-success' : 'bg-danger'}">${m.tipo.toUpperCase()}</span></td>
            <td>${m.quantidade}</td>
            <td>${m.descricao}</td>
          `;
          histBody.appendChild(tr);
        });
      }
      
      // abrir modal (Bootstrap 5)
      const modal = new bootstrap.Modal(document.getElementById('modalHistorico'));
      modal.show();
    } catch (err) {
      console.error('Erro ao carregar histórico:', err);
      showAlert('danger', 'Erro ao carregar histórico: ' + err.message);
    }
  }

  // Excluir produto
  async function excluirProduto(produto_id, produto_nome) {
    if (!confirm(`Tem certeza que deseja excluir o produto "${produto_nome}"? Esta ação não pode ser desfeita.`)) {
      return;
    }
    const resp = await fetch(`/api/produtos/${produto_id}`, {
      method: 'DELETE',
      headers: {'Content-Type':'application/json'}
    });
    const dados = await resp.json();
    if (resp.ok) {
      showAlert('success', dados.mensagem || 'Produto excluído com sucesso');
      carregarProdutos();
    } else {
      showAlert('danger', dados.detalhe || 'Erro ao excluir produto');
    }
  }

  // Busca por nome
  document.getElementById('btnSearch').addEventListener('click', () => {
    carregarProdutos(document.getElementById('searchInput').value);
  });
  document.getElementById('searchInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      carregarProdutos(document.getElementById('searchInput').value);
    }
  });

  // Carrega ao abrir
  carregarProdutos();
</script>
{% endblock %}

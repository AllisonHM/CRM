{% extends "base.html" %}
{% block title %}Canais{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<style>
  /* Bot√£o voltar padr√£o */
  .voltar-topo {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    text-decoration: none;
    background: #2c2f36;
    color: #fff;
    padding: 8px 14px;
    border-radius: 6px;
    font-weight: 500;
  }

  .voltar-topo:hover {
    background: #3a3f47;
    color: #fff;
  }

  /* Chat bubbles */
  .msg-bubble {
    display: inline-block;
    padding: .45rem .65rem;
    border-radius: 14px;
    margin: 2px 0;
    max-width: 85%;
    word-wrap: break-word;
  }
  .msg-me { background: #198754; color: #fff; }
  .msg-other { background: #e9ecef; color: #212529; }

  /* Notifica√ß√µes */
  #notificacoes-list .list-group-item { cursor: pointer; }
  .notif-preview { font-size: 0.85rem; color: #6c757d; }
  .notif-messages { margin-top: .5rem; display:flex; flex-direction:column; gap:4px; }
  .notif-message { font-size: 0.78rem; padding:6px 8px; border-radius:10px; }
  .notif-message.me { background:#d1e7dd; color:#0f5132; align-self:flex-end; }
  .notif-message.other { background:#f8f9fa; color:#212529; align-self:flex-start; }
</style>

<!-- üîô Bot√£o Voltar (PADR√ÉO) -->
<a href="{{ url_for('menu') }}" class="voltar-topo">‚¨Ö Voltar</a>

<div class="container-fluid mt-3">
  <div class="row">
    <div style="color:red">
      TOTAL CLIENTES: {{ clientes|length }}
    </div>

    <!-- COLUNA ESQUERDA -->
    <div class="col-4 border-end">
      <h5 class="mb-2">Notifica√ß√µes</h5>
      <div id="notificacoes-list" class="list-group mb-3"></div>

      <h5 class="mb-2">Buscar cliente</h5>
      <div class="contacts">
        <div class="contacts-title">Contatos</div>

        <div class="p-2">
          <input
            type="text"
            id="search-contact"
            class="form-control"
            placeholder="Buscar contato..."
          />
        </div>

        <div id="contacts-list">
          {% for c in clientes %}
            <div class="contact-item" data-nome="{{ c.nome|lower }}" data-numero="{{ c.telefone }}">
              <strong>{{ c.nome }}</strong><br>
              <small>{{ c.telefone }}</small>
            </div>
          {% endfor %}
        </div>
      </div>

      <input
        type="text"
        id="busca"
        class="form-control mb-2 mt-3"
        placeholder="Nome ou telefone..."
      >

      <div id="lista-clientes" class="list-group"></div>
    </div>

    <!-- COLUNA DIREITA -->
    <div class="col-8 d-flex flex-column" style="height:75vh">

      <div id="chat-header" class="border-bottom p-2 fw-bold">
        Nenhum cliente selecionado
      </div>

      <div
        id="mensagens"
        class="flex-grow-1 p-2 overflow-auto"
        style="background:#f8f9fa"
      ></div>

      <div class="input-group mt-2">
        <input
          type="text"
          id="mensagem"
          class="form-control"
          placeholder="Digite a mensagem"
        >
        <button class="btn btn-success" id="enviar">Enviar</button>
      </div>

    </div>
  </div>
</div>

<script>
let socket = window.socket || null;
let clienteSelecionado = null;
const seenMessageIds = new Set();
const notifications = new Map();

/* ===========================
   NOTIFICA√á√ïES
=========================== */
async function carregarNotificacoes() {
  try {
    const res = await fetch('/canais/ultimas');
    const list = await res.json();
    const container = document.getElementById('notificacoes-list');
    container.innerHTML = '';
    list.forEach(item => {
      notifications.set(item.numero, item);
      const el = criarItemNotificacao(item);
      container.appendChild(el);
    });
  } catch (e) {
    console.error('Erro ao carregar notifica√ß√µes', e);
  }
}

function criarItemNotificacao(item) {
  const div = document.createElement('div');
  div.className = 'list-group-item';
  div.dataset.numero = item.numero;

  const header = document.createElement('div');
  header.className = 'd-flex w-100 justify-content-between';
  header.innerHTML = `<h6 class="mb-0">${item.nome}</h6><small class="text-muted">${item.recebido_em.slice(11,16)}</small>`;

  const preview = document.createElement('div');
  preview.className = 'notif-preview';
  preview.innerText = item.mensagem || '';

  div.appendChild(header);
  div.appendChild(preview);

  div.addEventListener('click', async () => {
    const res = await fetch(`/canais/${item.numero}/mensagens`);
    const json = await res.json();
    selecionarCliente(json.cliente || { nome: item.nome, telefone: item.numero });
  });

  return div;
}

/* ===========================
   BUSCA CLIENTES
=========================== */
document.getElementById("busca").addEventListener("keyup", async e => {
  const q = e.target.value.trim();
  const lista = document.getElementById("lista-clientes");
  lista.innerHTML = "";

  if (q.length < 2) return;

  const res = await fetch(`/api/clientes/busca?q=${encodeURIComponent(q)}`);
  const clientes = await res.json();

  clientes.forEach(c => {
    const item = document.createElement("button");
    item.className = "list-group-item list-group-item-action";
    item.innerHTML = `<strong>${c.nome}</strong><br><small>${c.telefone}</small>`;
    item.onclick = () => selecionarCliente(c);
    lista.appendChild(item);
  });
});

/* ===========================
   SELECIONAR CLIENTE
=========================== */
async function selecionarCliente(cliente) {
  const numero_norm = (cliente.telefone || "").toString().replace(/\D/g, "");
  clienteSelecionado = { ...cliente, telefone_norm: numero_norm };

  document.getElementById("chat-header").innerText =
    `${cliente.nome} - ${cliente.telefone}`;

  document.getElementById("mensagens").innerHTML = "";

  if (socket) socket.emit("join", { numero: numero_norm });

  const res = await fetch(`/canais/${numero_norm}/mensagens`);
  const json = await res.json();

  json.mensagens.forEach(m => adicionarMensagem(m.remetente, m.mensagem, m.id));
}

/* ===========================
   ENVIO
=========================== */
document.getElementById("enviar").onclick = async () => {
  const input = document.getElementById("mensagem");
  const texto = input.value.trim();
  if (!texto || !clienteSelecionado) return;

  adicionarMensagem("Voc√™", texto);
  input.value = "";

  await fetch("/canais/enviar", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      numero: clienteSelecionado.telefone_norm,
      mensagem: texto
    })
  });
};

/* ===========================
   UI
=========================== */
function adicionarMensagem(remetente, texto, id=null) {
  if (id && seenMessageIds.has(id)) return;
  if (id) seenMessageIds.add(id);

  const div = document.createElement("div");
  div.className = remetente === "Voc√™" ? "text-end mb-2" : "text-start mb-2";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble " + (remetente === "Voc√™" ? "msg-me" : "msg-other");
  bubble.innerText = texto;

  div.appendChild(bubble);
  const box = document.getElementById("mensagens");
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* ===========================
   FILTRO CONTATOS
=========================== */
document.getElementById("search-contact").addEventListener("input", function () {
  const termo = this.value.toLowerCase().trim();
  document.querySelectorAll(".contact-item").forEach(contato => {
    const nome = contato.dataset.nome || "";
    const numero = contato.dataset.numero || "";
    contato.style.display =
      nome.includes(termo) || numero.includes(termo) ? "block" : "none";
  });
});

document.addEventListener("DOMContentLoaded", carregarNotificacoes);
</script>

{% endblock %}

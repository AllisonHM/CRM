{% extends "base.html" %}
{% block title %}Canais{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  
  /* Container principal */
  .messages-container-main {
    display: flex;
    height: 92vh;
    background: #f0f2f5;
    overflow: hidden;
  }
  
  /* SIDEBAR (Lista de conversas) */
  .sidebar {
    width: 400px;
    background: #fff;
    border-right: 1px solid #e9edef;
    display: flex;
    flex-direction: column;
  }
  
  .sidebar-header {
    background: #f0f2f5;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9edef;
    gap: 10px;
  }
  
  .sidebar-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: #111b21;
  }
  
  .header-buttons {
    display: flex;
    gap: 8px;
  }
  
  .header-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: #667781;
    font-size: 1.2rem;
    transition: color 0.2s;
    padding: 5px;
  }
  
  .header-btn:hover {
    color: #111b21;
  }
  
  .search-box {
    padding: 10px 15px;
    background: #f0f2f5;
  }
  
  .search-input {
    width: 100%;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    background: #fff;
    outline: none;
    font-size: 0.9rem;
  }
  
  /* Lista de conversas */
  .conversations-list {
    flex: 1;
    overflow-y: auto;
    background: #fff;
  }
  
  .conversation-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f2f5;
    transition: background 0.2s;
    position: relative;
  }
  
  .conversation-item:hover {
    background: #f5f6f6;
  }
  
  .conversation-item:hover .delete-chat-btn {
    display: flex !important;
  }
  
  .conversation-item.active {
    background: #f0f2f5;
  }
  
  .delete-chat-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: none;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: #f5f5f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    color: #e53e3e;
    transition: all 0.2s;
  }
  
  .delete-chat-btn:hover {
    background: #fee;
    color: #c53030;
  }
  
  .conversation-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.2rem;
    margin-right: 15px;
    flex-shrink: 0;
  }
  
  .conversation-info {
    flex: 1;
    overflow: hidden;
  }
  
  .conversation-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  
  .conversation-name {
    font-weight: 600;
    color: #111b21;
    font-size: 1rem;
  }
  
  .conversation-time {
    font-size: 0.75rem;
    color: #667781;
  }
  
  .conversation-preview {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .conversation-last-msg {
    color: #667781;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
  }
  
  .conversation-badge {
    background: #25d366;
    color: white;
    border-radius: 50%;
    min-width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    margin-left: 8px;
  }
  
  /* CHAT AREA */
  .chat-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #efeae2;
  }
  
  .chat-header {
    background: #f0f2f5;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #e9edef;
  }
  
  .chat-header-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    margin-right: 15px;
  }
  
  .chat-header-info {
    flex: 1;
  }
  
  .chat-header-name {
    font-weight: 600;
    color: #111b21;
    font-size: 1rem;
  }
  
  .chat-header-status {
    font-size: 0.8rem;
    color: #667781;
  }
  
  /* Mensagens */
  .messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23e5ddd5" width="100" height="100"/><path fill="%23d9d9d9" opacity="0.1" d="M0 0h100v100H0z"/></svg>');
  }
  
  .message-wrapper {
    display: flex;
    margin-bottom: 12px;
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message-wrapper.sent {
    justify-content: flex-end;
  }
  
  .message-wrapper.received {
    justify-content: flex-start;
  }
  
  .message-bubble {
    max-width: 65%;
    padding: 8px 12px;
    border-radius: 8px;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .message-bubble.sent {
    background: #d9fdd3;
    border-bottom-right-radius: 0;
  }
  
  .message-bubble.received {
    background: #fff;
    border-bottom-left-radius: 0;
  }
  
  .message-text {
    color: #111b21;
    font-size: 0.95rem;
    word-wrap: break-word;
    white-space: pre-wrap;
    margin-bottom: 4px;
  }
  
  .message-meta {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    font-size: 0.7rem;
    color: #667781;
  }
  
  .message-time {
    font-size: 0.7rem;
    color: #667781;
  }
  
  .message-status {
    font-size: 0.8rem;
    color: #53bdeb;
  }
  
  /* Input area */
  .input-area {
    background: #f0f2f5;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .input-box {
    flex: 1;
    background: #fff;
    border-radius: 8px;
    padding: 10px 15px;
    border: none;
    outline: none;
    font-size: 0.95rem;
    resize: none;
    max-height: 100px;
  }
  
  .send-button {
    background: #25d366;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .send-button:hover {
    background: #20bd5a;
  }
  
  .send-button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  
  /* Empty state */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #667781;
  }
  
  .empty-state i {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.3;
  }
  
  .empty-state h3 {
    font-weight: 300;
    font-size: 2rem;
  }
  
  .empty-state p {
    margin-top: 10px;
    font-size: 0.9rem;
  }
  
  /* Notificação toast */
  .toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #25d366;
    color: white;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    animation: slideIn 0.3s ease-out;
    cursor: pointer;
  }
  
  @keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  .toast-notification.hide {
    animation: slideOut 0.3s ease-out forwards;
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
  
  /* Scroll customizado */
  .conversations-list::-webkit-scrollbar,
  .messages-container::-webkit-scrollbar {
    width: 6px;
  }
  
  .conversations-list::-webkit-scrollbar-thumb,
  .messages-container::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 3px;
  }
  
  /* Indicador de digitando */
  .typing-indicator {
    display: none;
    padding: 15px;
    color: #667781;
    font-size: 0.85rem;
    font-style: italic;
  }
  
  .typing-indicator.show {
    display: block;
  }
  
  /* Modal de confirmação */
  .delete-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  
  .delete-modal.show {
    display: flex;
  }
  
  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    text-align: center;
    max-width: 400px;
  }
  
  .modal-content h5 {
    margin-bottom: 10px;
    color: #111b21;
  }
  
  .modal-content p {
    color: #667781;
    margin-bottom: 25px;
  }
  
  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
  }
  
  .btn-cancel, .btn-delete {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  .btn-cancel {
    background: #e9ecef;
    color: #111b21;
  }
  
  .btn-cancel:hover {
    background: #dee2e6;
  }
  
  .btn-delete {
    background: #e53e3e;
    color: white;
  }
  
  .btn-delete:hover {
    background: #c53030;
  }
  
  /* Responsivo */
  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      display: none;
    }
    
    .sidebar.show {
      display: flex;
    }
    
    .chat-area {
      display: none;
    }
    
    .chat-area.show {
      display: flex;
    }
  }
</style>

<div class="messages-container-main">
  <!-- SIDEBAR - Lista de conversas -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <i class="fas fa-comments" style="color: #0d6efd; margin-right: 8px;"></i>
        Mensagens
      </div>
      <div class="header-buttons">
        <button class="header-btn" id="select-mode-btn" title="Deletar conversas">
          <i class="fas fa-trash"></i>
        </button>
        <span class="badge bg-primary" id="total-conversas">0</span>
      </div>
    </div>
    
    <div class="search-box">
      <input 
        type="text" 
        class="search-input" 
        id="search-contact" 
        placeholder="Buscar ou começar uma nova conversa"
      >
    </div>
    
    <div class="conversations-list" id="conversations-list">
      <!-- Conversas serão inseridas aqui dinamicamente -->
    </div>
  </div>
  
  <!-- CHAT AREA -->
  <div class="chat-area" id="chat-area">
    <div id="empty-state" class="empty-state">
      <i class="fas fa-comments"></i>
      <h3>Suas Mensagens</h3>
      <p>Selecione uma conversa para começar</p>
    </div>
    
    <div id="active-chat" style="display: none; flex-direction: column; height: 100%;">
      <div class="chat-header">
        <div class="chat-header-avatar" id="chat-avatar"></div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="chat-name"></div>
          <div class="chat-header-status" id="chat-status">online</div>
        </div>
      </div>
      
      <div class="messages-container" id="messages-container">
        <!-- Mensagens serão inseridas aqui -->
      </div>
      
      <div class="typing-indicator" id="typing-indicator">
        <i class="fas fa-circle" style="font-size: 0.5rem; animation: pulse 1.5s infinite;"></i>
        <i class="fas fa-circle" style="font-size: 0.5rem; animation: pulse 1.5s infinite 0.2s;"></i>
        <i class="fas fa-circle" style="font-size: 0.5rem; animation: pulse 1.5s infinite 0.4s;"></i>
        digitando...
      </div>
      
      <div class="input-area">
        <button class="btn btn-link" style="color: #667781;">
          <i class="far fa-smile fa-lg"></i>
        </button>
        <textarea 
          class="input-box" 
          id="message-input" 
          placeholder="Digite uma mensagem"
          rows="1"
        ></textarea>
        <button class="send-button" id="send-button">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmação de deleção -->
<div class="delete-modal" id="delete-modal">
  <div class="modal-content">
    <h5><i class="fas fa-exclamation-triangle" style="color: #e53e3e; margin-right: 10px;"></i>Deletar conversa</h5>
    <p id="delete-message">Tem certeza que deseja deletar esta conversa? Todas as mensagens serão removidas.</p>
    <div class="modal-buttons">
      <button class="btn-cancel" id="btn-cancel">Cancelar</button>
      <button class="btn-delete" id="btn-delete-confirm">Deletar</button>
    </div>
  </div>
</div>

<style>
  @keyframes pulse {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
  }
</style>

<script>
// ===========================
// CONFIGURAÇÃO INICIAL
// ===========================
let socket = window.socket || null;
let activeContact = null;
let conversations = new Map();
let seenMessageIds = new Set();
let isSearching = false; // evita sobrescrever a lista enquanto busca
let notificationSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OihUQ=='); // Som de notificação básico

// ===========================
// INICIALIZAÇÃO
// ===========================
document.addEventListener("DOMContentLoaded", () => {
  initializeSocketIO();
  loadConversations();
  setupEventListeners();
  
  // Atualizar conversas a cada 10 segundos
  setInterval(loadConversations, 10000);
});

// ===========================
// SOCKET.IO
// ===========================
function initializeSocketIO() {
  if (!socket && window.io) {
    socket = window.io();
    
    socket.on('connect', () => {
      console.log('✅ Socket conectado');
    });
    
    socket.on('nova_mensagem', (data) => {
      handleNewMessage(data);
    });
    
    socket.on('disconnect', () => {
      console.log('❌ Socket desconectado');
    });
  }
}

// ===========================
// CARREGAR CONVERSAS
// ===========================
async function loadConversations() {
  try {
    if (isSearching) return; // não sobrescrever enquanto o usuário pesquisa

    const response = await fetch('/canais/ultimas');
    if (!response.ok) throw new Error('Erro ao carregar conversas');
    
    const data = await response.json();
    const container = document.getElementById('conversations-list');
    
    // Limpar e recriar lista (mantendo seleção)
    const currentActive = activeContact?.numero;
    container.innerHTML = '';
    
    data.forEach(conv => {
      const numeroNorm = normalizeNumber(conv.numero);
      const existing = conversations.get(numeroNorm) || {};
      const safeConv = {
        numero: numeroNorm,
        nome: existing.nome && existing.nome !== existing.numero ? existing.nome : (conv.nome || numeroNorm),
        mensagem: conv.mensagem || existing.mensagem || '',
        recebido_em: conv.recebido_em || existing.recebido_em || new Date().toISOString()
      };

      conversations.set(numeroNorm, safeConv);
    });

    renderConversationList(container, currentActive);
    document.getElementById('total-conversas').textContent = conversations.size;
    
  } catch (error) {
    console.error('Erro ao carregar conversas:', error);
  }
}

// ===========================
// RENDERIZAR LISTA DE CONVERSAS
// ===========================
function renderConversationList(container, currentActive) {
  container.innerHTML = '';

  // Ordena por recebido_em desc
  const ordered = Array.from(conversations.values()).sort((a, b) => {
    return new Date(b.recebido_em) - new Date(a.recebido_em);
  });

  ordered.forEach(conv => {
    const element = createConversationItem(conv);
    if (currentActive && conv.numero === currentActive) {
      element.classList.add('active');
    }
    container.appendChild(element);
  });
}

// ===========================
// CRIAR ITEM DE CONVERSA
// ===========================
function createConversationItem(conv) {
  const div = document.createElement('div');
  div.className = 'conversation-item';
  const numeroNorm = normalizeNumber(conv.numero);
  div.dataset.numero = numeroNorm;
  
  // Avatar com iniciais
  const initials = conv.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
  
  // Formatar hora
  const time = formatTime(conv.recebido_em);
  
  // Preview da mensagem
  const previewText = (conv.mensagem || '').toString();
  const preview = previewText.substring(0, 50) + (previewText.length > 50 ? '...' : '');
  
  div.innerHTML = `
    <div class="conversation-avatar">${initials}</div>
    <div class="conversation-info">
      <div class="conversation-header">
        <div class="conversation-name">${conv.nome}</div>
        <div class="conversation-time">${time}</div>
      </div>
      <div class="conversation-preview">
        <div class="conversation-last-msg">${preview}</div>
      </div>
    </div>
    <button class="delete-chat-btn" data-numero="${conv.numero}" style="display: none;">
      <i class="fas fa-trash-alt"></i>
    </button>
  `;
  
  // Evento de clique na conversa
  div.addEventListener('click', (e) => {
    if (!e.target.closest('.delete-chat-btn')) {
      selectConversation({ ...conv, numero: numeroNorm });
    }
  });
  
  // Evento de deletar
  const deleteBtn = div.querySelector('.delete-chat-btn');
  deleteBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    openDeleteModal(conv);
  });
  
  return div;
}

// ===========================
// MODAL DE DELEÇÃO
// ===========================
function openDeleteModal(conv) {
  let chatToDelete = conv;
  document.getElementById('delete-message').textContent = `Tem certeza que deseja deletar a conversa com ${conv.nome}? Todas as mensagens serão removidas.`;
  document.getElementById('delete-modal').classList.add('show');
  
  // Armazenar no window para usar na confirmação
  window.chatToDelete = chatToDelete;
}

function closeDeleteModal() {
  document.getElementById('delete-modal').classList.remove('show');
  window.chatToDelete = null;
}

async function deleteConversation() {
  const chatToDelete = window.chatToDelete;
  if (!chatToDelete) return;
  
  try {
    const response = await fetch(`/canais/${chatToDelete.numero}/deletar`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (!response.ok) throw new Error('Erro ao deletar conversa');
    
    // Remover da UI
    const element = document.querySelector(`[data-numero="${chatToDelete.numero}"]`);
    if (element) element.remove();
    
    // Fechar chat ativo se for o mesmo
    if (activeContact?.numero === chatToDelete.numero) {
      document.getElementById('active-chat').style.display = 'none';
      document.getElementById('empty-state').style.display = 'flex';
      activeContact = null;
    }
    
    showNotification('Conversa deletada com sucesso', 'success');
    closeDeleteModal();
    loadConversations();
    
  } catch (error) {
    console.error('Erro ao deletar:', error);
    showNotification('Erro ao deletar a conversa', 'error');
  }
}

// ===========================
// SELECIONAR CONVERSA
// ===========================
async function selectConversation(contact) {
  const numeroNorm = normalizeNumber(contact.numero);
  activeContact = { ...contact, numero: numeroNorm };
  
  // Atualizar UI
  document.querySelectorAll('.conversation-item').forEach(item => {
    item.classList.remove('active');
  });
  document.querySelector(`[data-numero="${numeroNorm}"]`)?.classList.add('active');
  
  // Mostrar chat
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('active-chat').style.display = 'flex';
  
  // Atualizar header
  const initials = contact.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
  document.getElementById('chat-avatar').textContent = initials;
  document.getElementById('chat-name').textContent = contact.nome;
  document.getElementById('chat-status').textContent = numeroNorm;
  
  // Limpar mensagens antigas
  document.getElementById('messages-container').innerHTML = '';
  seenMessageIds.clear();
  
  // Entrar na sala do socket
  if (socket) {
    socket.emit('join', { numero: numeroNorm });
  }
  
  // Carregar mensagens
  await loadMessages(numeroNorm);
}

// ===========================
// CARREGAR MENSAGENS
// ===========================
async function loadMessages(numero) {
  try {
    const response = await fetch(`/canais/${numero}/mensagens`);
    if (!response.ok) throw new Error('Erro ao carregar mensagens');
    
    const data = await response.json();
    
    data.mensagens.forEach(msg => {
      addMessageToUI(msg.remetente, msg.mensagem, msg.hora, msg.id);
    });
    
    scrollToBottom();
    
  } catch (error) {
    console.error('Erro ao carregar mensagens:', error);
  }
}

// ===========================
// ADICIONAR MENSAGEM NA UI
// ===========================
function addMessageToUI(sender, text, timestamp, id = null) {
  if (id && seenMessageIds.has(id)) return;
  if (id) seenMessageIds.add(id);
  
  const container = document.getElementById('messages-container');
  const isMe = sender === 'Você';
  
  const wrapper = document.createElement('div');
  wrapper.className = `message-wrapper ${isMe ? 'sent' : 'received'}`;
  
  const bubble = document.createElement('div');
  bubble.className = `message-bubble ${isMe ? 'sent' : 'received'}`;
  
  const textDiv = document.createElement('div');
  textDiv.className = 'message-text';
  textDiv.textContent = text;
  
  const meta = document.createElement('div');
  meta.className = 'message-meta';
  
  const time = document.createElement('span');
  time.className = 'message-time';
  time.textContent = formatMessageTime(timestamp);
  
  meta.appendChild(time);
  
  if (isMe) {
    const status = document.createElement('i');
    status.className = 'fas fa-check-double message-status';
    meta.appendChild(status);
  }
  
  bubble.appendChild(textDiv);
  bubble.appendChild(meta);
  wrapper.appendChild(bubble);
  container.appendChild(wrapper);
  
  scrollToBottom();
}

// ===========================
// ENVIAR MENSAGEM
// ===========================
async function sendMessage() {
  const input = document.getElementById('message-input');
  const text = input.value.trim();
  
  if (!text || !activeContact) return;
  const numeroNorm = normalizeNumber(activeContact.numero);
  
  // Limpar input
  input.value = '';
  input.style.height = 'auto';
  
  // Adicionar na UI imediatamente
  addMessageToUI('Você', text, new Date().toISOString());

  // Atualizar a lista local imediatamente para evitar duplicidade e mostrar preview
  const nowIso = new Date().toISOString();
  const updated = {
    numero: numeroNorm,
    nome: activeContact.nome || numeroNorm,
    mensagem: text,
    recebido_em: nowIso
  };
  conversations.set(numeroNorm, updated);
  renderConversationList(document.getElementById('conversations-list'), numeroNorm);
  
  // Enviar para servidor
  try {
    const response = await fetch('/canais/enviar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        numero: numeroNorm,
        mensagem: text
      })
    });
    
    if (!response.ok) {
      throw new Error('Erro ao enviar mensagem');
    }
    
  } catch (error) {
    console.error('Erro ao enviar:', error);
    showNotification('Erro ao enviar mensagem', 'error');
  }
}

// ===========================
// NOVA MENSAGEM (SOCKET)
// ===========================
function handleNewMessage(data) {
  const numeroNorm = normalizeNumber(data.numero);
  const { remetente, mensagem, id } = data;
  
  // Se for do contato ativo, adicionar no chat
  if (activeContact && activeContact.numero === numeroNorm) {
    addMessageToUI(remetente, mensagem, new Date().toISOString(), id);
  } else {
    // Mostrar notificação
    showNotification(`Nova mensagem de ${remetente}`, 'success');
    playNotificationSound();
  }
  
  // Atualizar lista de conversas localmente para evitar duplicidade
  const existing = conversations.get(numeroNorm) || {};
  const merged = {
    numero: numeroNorm,
    nome: existing.nome || numeroNorm,
    mensagem: mensagem,
    recebido_em: new Date().toISOString()
  };
  conversations.set(numeroNorm, merged);
  renderConversationList(document.getElementById('conversations-list'), activeContact?.numero);
}

// ===========================
// BUSCA DE CONTATOS
// ===========================
let searchTimeout;
document.getElementById('search-contact').addEventListener('input', (e) => {
  clearTimeout(searchTimeout);
  const query = e.target.value.trim().toLowerCase();
  
  if (query.length === 0) {
    isSearching = false;
    loadConversations();
    return;
  }

  if (query.length < 2) {
    return;
  }
  
  // Buscar contatos após 300ms (debounce)
  searchTimeout = setTimeout(async () => {
    await searchContacts(query);
  }, 300);
});

async function searchContacts(query) {
  isSearching = true;
  try {
    const response = await fetch(`/api/clientes/busca?q=${encodeURIComponent(query)}`);
    if (!response.ok) throw new Error('Erro ao buscar clientes');

    const clientes = await response.json();
    const container = document.getElementById('conversations-list');
    container.innerHTML = '';

    clientes.forEach(cliente => {
      const numeroNorm = normalizeNumber(cliente.telefone);
      const existing = conversations.get(numeroNorm) || {};
      const conv = {
        numero: numeroNorm,
        nome: cliente.nome || existing.nome || numeroNorm,
        mensagem: existing.mensagem || 'Iniciar conversa',
        recebido_em: existing.recebido_em || new Date().toISOString()
      };
      conversations.set(numeroNorm, conv);
      const element = createConversationItem(conv);
      container.appendChild(element);
    });

    document.getElementById('total-conversas').textContent = clientes.length;
  } catch (error) {
    console.error('Erro ao buscar contatos:', error);
  }
}

// ===========================
// EVENT LISTENERS
// ===========================
function setupEventListeners() {
  // Botão enviar
  document.getElementById('send-button').addEventListener('click', sendMessage);
  
  // Enter para enviar
  document.getElementById('message-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  
  // Auto-resize textarea
  document.getElementById('message-input').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
  });
  
  // Modal de deleção
  document.getElementById('btn-cancel').addEventListener('click', closeDeleteModal);
  document.getElementById('btn-delete-confirm').addEventListener('click', deleteConversation);
  document.getElementById('delete-modal').addEventListener('click', (e) => {
    if (e.target.id === 'delete-modal') closeDeleteModal();
  });
  
  // Botão de seleção (deletar)
  document.getElementById('select-mode-btn').addEventListener('click', () => {
    if (conversations.size === 0) {
      showNotification('Nenhuma conversa para deletar', 'error');
      return;
    }
    
    // Mostrar opção de seleção rápida
    const firstConv = Array.from(conversations.values())[0];
    if (firstConv) {
      openDeleteModal(firstConv);
    }
  });
}

// ===========================
// UTILITÁRIOS
// ===========================
function formatTime(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
  } else if (diffDays === 1) {
    return 'Ontem';
  } else if (diffDays < 7) {
    return date.toLocaleDateString('pt-BR', { weekday: 'short' });
  } else {
    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
  }
}

function formatMessageTime(dateString) {
  const date = new Date(dateString);
  return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

function scrollToBottom() {
  const container = document.getElementById('messages-container');
  setTimeout(() => {
    container.scrollTop = container.scrollHeight;
  }, 100);
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = 'toast-notification';
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
    ${message}
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.classList.add('hide');
    setTimeout(() => notification.remove(), 300);
  }, 3000);
  
  notification.addEventListener('click', () => {
    notification.classList.add('hide');
    setTimeout(() => notification.remove(), 300);
  });
}

function playNotificationSound() {
  try {
    notificationSound.play().catch(e => console.log('Não foi possível tocar o som'));
  } catch (e) {
    console.log('Som de notificação não disponível');
  }
}

// Normaliza número de telefone para apenas dígitos
function normalizeNumber(numero) {
  return (numero || '').toString().replace(/\D/g, '');
}
</script>

{% endblock %}
